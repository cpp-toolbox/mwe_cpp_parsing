#include "grid_font.hpp"
#include <algorithm>

namespace grid_font {

// https://www.dafont.com/sburbits.charmap?back=bitmap
//

std::string zero = R"(
----------
-****-----
**--**----
**--**----
**--**----
**--**----
**--**----
**--**----
**--**----
-****-----
----------
----------
----------
)";

std::string one = R"(
----------
--**------
****------
--**------
--**------
--**------
--**------
--**------
--**------
******----
----------
----------
----------
)";

std::string two = R"(
----------
-****-----
**--**----
**--**----
----**----
---**-----
--**------
-**-------
**--------
******----
----------
----------
----------
)";

std::string three = R"(
----------
-****-----
*---**----
----**----
----**----
--***-----
----**----
----**----
*---**----
-****-----
----------
----------
----------
)";

std::string four = R"(
----------
---***----
---***----
--****----
--*-**----
-**-**----
-*--**----
*******---
----**----
--*****---
----------
----------
----------
)";

std::string five = R"(
----------
-*****----
-**-------
-**-------
-****-----
-*--**----
----**----
----**----
*---**----
-****-----
----------
----------
----------
)";

std::string six = R"(
----------
--****----
-**-------
**--------
**-**-----
***-**----
**--**----
**--**----
**--**----
-****-----
----------
----------
----------
)";

std::string seven = R"(
----------
******----
*---**----
---***----
---**-----
---**-----
---**-----
--***-----
--**------
--**------
----------
----------
----------
)";

std::string eight = R"(
----------
-****-----
**--**----
**--**----
**--**----
-****-----
**--**----
**--**----
**--**----
-****-----
----------
----------
----------
)";

std::string nine = R"(
----------
-****-----
**--**----
**--**----
**--**----
**-***----
-**-**----
----**----
---**-----
****------
----------
----------
----------
)";

std::string a_upper = R"(
----------
----------
-*****----
---***----
--**-**---
--**-**---
--**-**---
-*******--
-**---**--
****-****-
----------
----------
----------
)";

std::string b_upper = R"(
----------
----------
******----
-**--**---
-**--**---
-*****----
-**--**---
-**--**---
-**--**---
******----
----------
----------
----------
)";

std::string c_upper = R"(
----------
----------
--****----
-**--*----
**---*----
**--------
**--------
**--------
-**--*----
--****----
----------
----------
----------
)";

std::string d_upper = R"(
----------
----------
*****-----
-**-**----
-**--**---
-**--**---
-**--**---
-**--**---
-**-**----
*****-----
----------
----------
----------
)";

std::string e_upper = R"(
----------
----------
*******---
-**---*---
-**-*-*---
-****-----
-**-*-----
-**---*---
-**---*---
*******---
----------
----------
----------
)";

std::string f_upper = R"(
----------
----------
*******---
-**---*---
-**-*-*---
-****-----
-**-*-----
-**-------
-**-------
*****-----
----------
----------
----------
)";

std::string g_upper = R"(
----------
----------
-*****----
**---*----
**---*----
**--------
**-****---
**--**----
**--**----
-****-----
----------
----------
----------
)";

std::string h_upper = R"(
----------
----------
***--***--
-**--**---
-**--**---
-******---
-**--**---
-**--**---
-**--**---
***--***--
----------
----------
----------
)";

std::string i_upper = R"(
----------
----------
******----
--**------
--**------
--**------
--**------
--**------
--**------
******----
----------
----------
----------
)";

std::string j_upper = R"(
----------
----------
-*******--
-----**---
-----**---
-----**---
-----**---
**---**---
**---**---
******----
----------
----------
----------
)";

std::string k_upper = R"(
----------
----------
****-***--
-**--**---
-**-**----
-****-----
-*****----
-**--**---
-**--**---
****--**--
----------
----------
----------
)";

std::string l_upper = R"(
----------
----------
****------
-**-------
-**-------
-**-------
-**-------
-**---*---
-**---*---
*******---
----------
----------
----------
)";

std::string m_upper = R"(
----------
----------
***---***-
-***-***--
-***-***--
-*******--
-**-*-**--
-**-*-**--
-**---**--
****-****-
----------
----------
----------
)";

std::string n_upper = R"(
----------
----------
***-****--
-**--**---
-***-**---
-***-**---
-**-***---
-**-***---
-**--**---
****-**---
----------
----------
----------
)";

std::string o_upper = R"(
----------
----------
-****-----
**--**----
**--**----
**--**----
**--**----
**--**----
**--**----
-****-----
----------
----------
----------
)";

std::string p_upper = R"(
----------
----------
******----
-**--**---
-**--**---
-**--**---
-*****----
-**-------
-**-------
****------
----------
----------
----------
)";

std::string q_upper = R"(
----------
----------
-****-----
**--**----
**--**----
**--**----
**--**----
**--**----
**--**----
-****-----
--**-*----
--***-----
----------
)";

std::string r_upper = R"(
----------
----------
******----
-**--**---
-**--**---
-**--**---
-*****----
-**-**----
-**--**---
****--**--
----------
----------
----------
)";

std::string s_upper = R"(
----------
----------
-*****----
**--**----
**--------
-***------
--***-----
----**----
**--**----
*****-----
----------
----------
----------
)";

std::string t_upper = R"(
----------
----------
******----
*-**-*----
*-**-*----
--**------
--**------
--**------
--**------
-****-----
----------
----------
----------
)";

std::string u_upper = R"(
----------
----------
***--***--
-**--**---
-**--**---
-**--**---
-**--**---
-**--**---
-**--**---
--****----
----------
----------
----------
)";

std::string v_upper = R"(
----------
----------
****-****-
-**---**--
-**---**--
--**-**---
--**-**---
--**-**---
---***----
---***----
----------
----------
----------
)";

std::string w_upper = R"(
----------
----------
****-****-
-**---**--
-**-*-**--
-*******--
-***-***--
--**-**---
--**-**---
--**-**---
----------
----------
----------
)";

std::string x_upper = R"(
----------
----------
***-****--
-**--**---
--****----
---**-----
---**-----
--****----
-**--**---
****-***--
----------
----------
----------
)";

std::string y_upper = R"(
----------
----------
***-****--
-**--**---
--*--*----
--****----
---**-----
---**-----
---**-----
*******---
----------
----------
----------
)";

std::string z_upper = R"(
----------
----------
******----
*---**----
*--**-----
--**------
--**------
-**--*----
**---*----
******----
----------
----------
----------
)";

std::string a_lower = R"(
----------
----------
----------
----------
-****-----
----**----
-*****----
**--**----
**--**----
-******---
----------
----------
----------
)";

std::string b_lower = R"(
----------
***-------
-**-------
-**-------
-**-**----
-***-**---
-**--**---
-**--**---
-***-**---
***-**----
----------
----------
----------
)";

// todo was working on this
std::string c_lower = R"(
----------
----------
----------
----------
-*****----
**---*----
**---*----
**--------
**---*----
-****-----
----------
----------
----------
)";

std::string d_lower = R"(
----------
---***----
----**----
----**----
-**-**----
**-***----
**--**----
**--**----
**-***----
-**-***---
----------
----------
----------
)";

std::string e_lower = R"(
----------
----------
----------
----------
-****-----
**--**----
******----
**--------
**---*----
-****-----
----------
----------
----------
)";

std::string f_lower = R"(
----------
---*****--
--**------
--**------
*******---
--**------
--**------
--**------
--**------
*******---
----------
----------
----------
)";

std::string g_lower = R"(
----------
----------
----------
----------
-**-***---
**-***----
**--**----
**--**----
**-***----
-**-**----
----**----
----**----
-****-----
)";

std::string h_lower = R"(
----------
***-------
-**-------
-**-------
-*****----
-**--**---
-**--**---
-**--**---
-**--**---
***--***--
----------
----------
----------
)";

std::string i_lower = R"(
----------
--**------
--**------
----------
****------
--**------
--**------
--**------
--**------
******----
----------
----------
----------
)";

std::string j_lower = R"(
----------
---**-----
---**-----
----------
******----
----**----
----**----
----**----
----**----
----**----
----**----
----**----
*****-----
)";

std::string k_lower = R"(
----------
***-------
-**-------
-**-------
-**-***---
-**-**----
-****-----
-*****----
-**--**---
***-****--
----------
----------
----------
)";

std::string l_lower = R"(
----------
-****-----
---**-----
---**-----
---**-----
---**-----
---**-----
---**-----
---**-----
********--
----------
----------
----------
)";

std::string m_lower = R"(
----------
----------
----------
----------
********--
-**-**-**-
-**-**-**-
-**-**-**-
-**-**-**-
***-**-***
----------
----------
----------
)";

std::string n_lower = R"(
----------
----------
----------
----------
******----
-**--**---
-**--**---
-**--**---
-**--**---
***--***--
----------
----------
----------
)";

std::string o_lower = R"(
----------
----------
----------
----------
-****-----
**--**----
**--**----
**--**----
**--**----
-****-----
----------
----------
----------
)";

std::string p_lower = R"(
----------
----------
----------
----------
***-**----
-***-**---
-**--**---
-**--**---
-***-**---
-**-**----
-**-------
-**-------
*****-----
)";

std::string q_lower = R"(
----------
----------
----------
----------
-**-***---
**-***----
**--**----
**--**----
**-***----
-**-**----
----**----
----**----
--*****---
)";

std::string r_lower = R"(
----------
----------
----------
----------
****-**---
--***-*---
--**--*---
--**------
--**------
*******---
----------
----------
----------
)";

std::string s_lower = R"(
----------
----------
----------
----------
-*****----
**--**----
****------
--****----
**--**----
*****-----
----------
----------
----------
)";

std::string t_lower = R"(
----------
----------
-**-------
-**-------
*****-----
-**-------
-**-------
-**-------
-**--*----
--***-----
----------
----------
----------
)";

std::string u_lower = R"(
----------
----------
----------
----------
***-***---
-**--**---
-**--**---
-**--**---
-**--**---
--******--
----------
----------
----------
)";

std::string v_lower = R"(
----------
----------
----------
----------
***-***---
-**-**----
-**-**----
-**-**----
--***-----
--***-----
----------
----------
----------
)";

std::string w_lower = R"(
----------
----------
----------
----------
***---***-
-**-*-**--
-*******--
--**-**---
--**-**---
--*---*---
----------
----------
----------
)";

std::string x_lower = R"(
----------
----------
----------
----------
***--***--
-**--**---
--****----
--****----
-**--**---
***--***--
----------
----------
----------
)";

std::string y_lower = R"(
----------
----------
----------
----------
****-***--
-**--**---
-**--*----
--*-**----
--***-----
---**-----
--**------
--**------
*****-----
)";

std::string z_lower = R"(
----------
----------
----------
----------
******----
*--**-----
--**------
-**-------
**---*----
******----
----------
----------
----------
)";

std::string exclamation = R"(
----------
---*---
---*---
---*---
-------
---*---
)";

std::string question = R"(
----------
-*****-
----*--
---*---
-------
---*---
)";

std::string hash = R"(
----------
--*-*--
-*****-
--*-*--
-*****-
--*-*--
)";

std::string dollar = R"(
----------
---*---
-*****-
-*-*---
-*****-
---*---
)";

std::string percent = R"(
----------
-**--*-
-**-*--
---*---
--*-**-
-*--**-
)";

std::string plus = R"(
----------
----------
----------
---*------
---*------
---*------
*******---
---*------
---*------
---*------
----------
----------
----------
)";

std::string minus = R"(
----------
----------
----------
----------
----------
----------
*******---
----------
----------
----------
----------
----------
----------
)";

std::string ampersand = R"(
----------
----------
--****----
-**-------
-**-------
-**-------
****-**---
**-***----
**--**----
-******---
----------
----------
----------
)";

std::string asterisk = R"(
----------
--**------
--**------
******----
-****-----
-****-----
-*--*-----
----------
----------
----------
----------
----------
----------
)";

std::string at_symbol = R"(
----------
--***-----
-*---*----
*----*----
*--***----
*-*--*----
*-*--*----
*--***----
*---------
-*---*----
--***-----
----------
----------
)";

std::string period = R"(
----------
----------
----------
----------
----------
----------
----------
----------
**--------
**--------
----------
----------
----------
)";

std::string comma = R"(
----------
-------
-------
-------
--*----
-*-----
)";

std::string colon = R"(
----------
-------
---*---
-------
---*---
-------
)";

std::string angle_bracket_left = R"(
----------
----*--
---*---
--*----
---*---
----*--
)";

std::string angle_bracket_right = R"(
----------
--*----
---*---
----*--
---*---
--*----
)";

std::string forward_slash = R"(
----**----
----**----
---**-----
---**-----
---**-----
--**------
--**------
-**-------
-**-------
-**-------
**--------
**--------
----------
)";
std::string back_slash = R"(
**--------
**--------
-**-------
-**-------
-**-------
--**------
--**------
---**-----
---**-----
---**-----
----**----
----**----
----------
)";

std::string parenthesis_left = R"(
----------
--*-------
-**-------
-*--------
**--------
**--------
**--------
**--------
**--------
-*--------
-**-------
--*-------
----------
)";

std::string parenthesis_right = R"(
----------
*---------
**--------
-*--------
-**-------
-**-------
-**-------
-**-------
-**-------
-*--------
**--------
*---------
----------
)";

std::unordered_map<char, std::string> character_to_text_grid = {{'0', zero},
                                                                {'1', one},
                                                                {'2', two},
                                                                {'3', three},
                                                                {'4', four},
                                                                {'5', five},
                                                                {'6', six},
                                                                {'7', seven},
                                                                {'8', eight},
                                                                {'9', nine},
                                                                {'A', a_upper},
                                                                {'B', b_upper},
                                                                {'C', c_upper},
                                                                {'D', d_upper},
                                                                {'E', e_upper},
                                                                {'F', f_upper},
                                                                {'G', g_upper},
                                                                {'H', h_upper},
                                                                {'I', i_upper},
                                                                {'J', j_upper},
                                                                {'K', k_upper},
                                                                {'L', l_upper},
                                                                {'M', m_upper},
                                                                {'N', n_upper},
                                                                {'O', o_upper},
                                                                {'P', p_upper},
                                                                {'Q', q_upper},
                                                                {'R', r_upper},
                                                                {'S', s_upper},
                                                                {'T', t_upper},
                                                                {'U', u_upper},
                                                                {'V', v_upper},
                                                                {'W', w_upper},
                                                                {'X', x_upper},
                                                                {'Y', y_upper},
                                                                {'Z', z_upper},
                                                                {'a', a_lower},
                                                                {'b', b_lower},
                                                                {'c', c_lower},
                                                                {'d', d_lower},
                                                                {'e', e_lower},
                                                                {'f', f_lower},
                                                                {'g', g_lower},
                                                                {'h', h_lower},
                                                                {'i', i_lower},
                                                                {'j', j_lower},
                                                                {'k', k_lower},
                                                                {'l', l_lower},
                                                                {'m', m_lower},
                                                                {'n', n_lower},
                                                                {'o', o_lower},
                                                                {'p', p_lower},
                                                                {'q', q_lower},
                                                                {'r', r_lower},
                                                                {'s', s_lower},
                                                                {'t', t_lower},
                                                                {'u', u_lower},
                                                                {'v', v_lower},
                                                                {'w', w_lower},
                                                                {'x', x_lower},
                                                                {'y', y_lower},
                                                                {'z', z_lower},
                                                                {'!', exclamation},
                                                                {'?', question},
                                                                {'/', forward_slash},
                                                                {'\\', back_slash},
                                                                {'#', hash},
                                                                {'$', dollar},
                                                                {'%', percent},
                                                                {'&', ampersand},
                                                                {'*', asterisk},
                                                                {'@', at_symbol},
                                                                {'+', plus},
                                                                {'-', minus},
                                                                {'.', period},
                                                                {',', comma},
                                                                {':', colon},
                                                                {'<', angle_bracket_left},
                                                                {'>', angle_bracket_right},
                                                                {'(', parenthesis_left},
                                                                {')', parenthesis_right}};

draw_info::IndexedVertexPositions get_text_geometry(const std::string &text, vertex_geometry::Rectangle bounding_rect) {
    TextJustification justification = TextJustification::Left;
    if (text.empty()) {
        return draw_info::IndexedVertexPositions(); // Return empty geometry
    }

    // Check for multi-line input
    bool contains_newline = text.find('\n') != std::string::npos;
    if (contains_newline) {
        std::cout << "has newline" << std::endl;
        size_t line_count = std::count(text.begin(), text.end(), '\n') + 1;
        vertex_geometry::Grid text_lines_grid(line_count, 1, bounding_rect);

        // Extract lines and determine max length
        std::vector<std::string> lines;
        std::istringstream stream(text);
        std::string line;
        size_t max_line_length = 0;
        while (std::getline(stream, line)) {
            max_line_length = std::max(max_line_length, line.length());
            lines.push_back(std::move(line));
        }

        // Pad lines based on justification
        for (auto &line : lines) {
            size_t pad = max_line_length - line.length();
            if (justification == TextJustification::Left) {
                line.append(pad, ' ');
            } else if (justification == TextJustification::Right) {
                line.insert(0, pad, ' ');
            } else if (justification == TextJustification::Center) {
                size_t left_pad = pad / 2;
                size_t right_pad = pad - left_pad;
                line.insert(0, left_pad, ' ');
                line.append(right_pad, ' ');
            }
        }

        // Process each padded line
        std::vector<draw_info::IndexedVertexPositions> line_ivps;
        for (size_t i = 0; i < lines.size(); ++i) {
            vertex_geometry::Rectangle line_rect = text_lines_grid.get_at(0, i);
            line_ivps.push_back(get_text_geometry(lines[i], line_rect));
        }

        return vertex_geometry::merge_ivps(line_ivps);
    }

    std::cout << "no newline" << std::endl;

    // SINGLE LINE HANDLING:
    std::vector<draw_info::IndexedVertexPositions> character_ivps;
    character_ivps.reserve(text.size());

    // Character aspect ratio: width:height = 10:13
    const float char_aspect_ratio = 10.0f / 13.0f;

    // Calculate optimal character dimensions that fit within bounding rect
    float available_width = bounding_rect.width;
    float available_height = bounding_rect.height;

    // Method 1: Fit all characters horizontally first
    float char_width_horizontal = available_width / text.size();
    float char_height_horizontal = char_width_horizontal / char_aspect_ratio;

    // Method 2: Fit character height to available height
    float char_height_vertical = available_height;
    float char_width_vertical = char_height_vertical * char_aspect_ratio;
    float total_width_needed = char_width_vertical * text.size();

    // Choose the method that fits within bounds
    float final_char_width, final_char_height;
    if (char_height_horizontal <= available_height) {
        final_char_width = char_width_horizontal;
        final_char_height = char_height_horizontal;
    } else if (total_width_needed <= available_width) {
        final_char_width = char_width_vertical;
        final_char_height = char_height_vertical;
    } else {
        if (char_width_horizontal * char_height_horizontal >= char_width_vertical * char_height_vertical) {
            final_char_width = char_width_horizontal;
            final_char_height = char_height_horizontal;
        } else {
            final_char_width = char_width_vertical;
            final_char_height = char_height_vertical;
        }
    }

    // Center the entire line
    float total_text_width = final_char_width * text.size();
    float start_center_x = bounding_rect.center.x - (total_text_width / 2.0f) + (final_char_width / 2.0f);

    for (size_t i = 0; i < text.size(); ++i) {
        char ch = text[i];

        vertex_geometry::Rectangle character_bounding_rect;
        character_bounding_rect.center.x = start_center_x + i * final_char_width;
        character_bounding_rect.center.y = bounding_rect.center.y;
        character_bounding_rect.center.z = bounding_rect.center.z;
        character_bounding_rect.width = final_char_width;
        character_bounding_rect.height = final_char_height;

        std::string text_grid = character_to_text_grid[ch];
        character_ivps.push_back(vertex_geometry::text_grid_to_rect_grid(text_grid, character_bounding_rect));
    }

    return vertex_geometry::merge_ivps(character_ivps);
}

} // namespace grid_font
